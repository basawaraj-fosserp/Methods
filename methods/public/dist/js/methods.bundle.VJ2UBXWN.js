(()=>{erpnext.utils.BarcodeScanner=class{constructor(e){console.log("Enter"),this.frm=e.frm,this.scan_field_name=e.scan_field_name||"scan_barcode",this.scan_barcode_field=this.frm.fields_dict[this.scan_field_name],this.barcode_field=e.barcode_field||"barcode",this.serial_no_field=e.serial_no_field||"serial_no",this.batch_no_field=e.batch_no_field||"batch_no",this.against_sales_order="against_sales_order",this.so_detail="so_detail",this.uom_field=e.uom_field||"uom",this.qty_field=e.qty_field||"qty",this.max_qty_field=e.max_qty_field,this.dont_allow_new_row=e.dont_allow_new_row,this.prompt_qty=e.prompt_qty,this.items_table_name=e.items_table_name||"items",this.items_table=this.frm.doc[this.items_table_name],this.success_sound=e.play_success_sound,this.fail_sound=e.play_fail_sound,this.scan_api=e.scan_api||"erpnext.stock.utils.scan_barcode"}process_scan(){return new Promise((e,t)=>{let a=this,i=this.scan_barcode_field.value;this.scan_barcode_field.set_value(""),i&&(!this.frm.doc.sales_order_ref||this.scan_api_call(i,s=>{let _=s&&s.message;if(!_||Object.keys(_).length===0){this.show_alert(__("Cannot find Item with this Barcode"),"red"),this.clean_up(),this.play_fail_sound(),t();return}a.update_table(_).then(l=>{this.play_success_sound(),e(l)}).catch(()=>{this.play_fail_sound(),t()})}))})}scan_api_call(e,t){frappe.call({method:this.scan_api,args:{search_value:e}}).then(a=>{frappe.call({method:"methods.methods.get_so_ref",args:{sales_order:this.frm.doc.sales_order_ref,data:a.message}}).then(i=>{console.log(i),t(i)})})}update_table(e){return new Promise((t,a)=>{let i=this.frm.fields_dict[this.items_table_name].grid;frappe.flags.trigger_from_barcode_scanner=!0;let{item_code:s,barcode:_,batch_no:l,serial_no:n,uom:r,against_sales_order:o,so_detail:c}=e,d=this.get_row_to_modify_on_scan(s,l,r,_);if(this.is_new_row=!1,!d){if(this.dont_allow_new_row){this.show_alert(__("Maximum quantity scanned for item {0}.",[s]),"red"),this.clean_up(),a();return}this.is_new_row=!0,d=frappe.model.add_child(this.frm.doc,i.doctype,this.items_table_name),this.frm.script_manager.trigger(`${this.items_table_name}_add`,d.doctype,d.name),this.frm.has_items=!1}if(this.is_duplicate_serial_no(d,n)){this.clean_up(),a();return}frappe.run_serially([()=>this.set_selector_trigger_flag(e),()=>this.set_item(d,s,_,l,n,o,c).then(h=>{this.show_scan_message(d.idx,d.item_code,h)}),()=>this.set_barcode_uom(d,r),()=>this.set_serial_no(d,n),()=>this.set_batch_no(d,l),()=>this.set_barcode(d,_),()=>this.so_ref(d,o),()=>this.soi_ref(d,c),()=>this.clean_up(),()=>this.revert_selector_flag(),()=>t(d)])})}set_selector_trigger_flag(e){let{batch_no:t,serial_no:a,has_batch_no:i,has_serial_no:s}=e;i&&!t||s&&!a||(frappe.flags.hide_serial_batch_dialog=!0)}revert_selector_flag(){frappe.flags.hide_serial_batch_dialog=!1,frappe.flags.trigger_from_barcode_scanner=!1}set_item(e,t,a,i,s){return new Promise(_=>{let l=async(n=1)=>{let r={item_code:t,use_serial_batch_fields:1};return frappe.flags.trigger_from_barcode_scanner=!0,r[this.qty_field]=Number(e[this.qty_field]||0)+Number(n),await frappe.model.set_value(e.doctype,e.name,r),n};this.prompt_qty?frappe.prompt(__("Please enter quantity for item {0}",[t]),({value:n})=>{l(n).then(r=>_(r))}):this.frm.has_items?this.prepare_item_for_scan(e,t,a,i,s):l().then(n=>_(n))})}prepare_item_for_scan(e,t,a,i,s){var _=this;this.dialog=new frappe.ui.Dialog({title:__("Scan barcode for item {0}",[t]),fields:_.get_fields_for_dialog(e,t,a,i,s)}),this.dialog.set_primary_action(__("Update"),()=>{let l={item_code:t};l[this.qty_field]=this.dialog.get_value("scanned_qty"),l.has_item_scanned=1,this.remaining_qty=flt(this.dialog.get_value("qty"))-flt(this.dialog.get_value("scanned_qty")),frappe.model.set_value(e.doctype,e.name,l),frappe.run_serially([()=>this.set_batch_no(e,this.dialog.get_value("batch_no")),()=>this.set_barcode(e,this.dialog.get_value("barcode")),()=>this.set_serial_no(e,this.dialog.get_value("serial_no")),()=>this.add_child_for_remaining_qty(e),()=>this.clean_up()]),this.dialog.hide()}),this.dialog.show(),this.$scan_btn=this.dialog.$wrapper.find(".link-btn"),this.$scan_btn.css("display","inline")}get_fields_for_dialog(e,t,a,i,s){let _=[{fieldtype:"Data",fieldname:"barcode_scanner",options:"Barcode",label:__("Scan Barcode"),onchange:l=>{!l||l.target.value&&this.scan_api_call(l.target.value,n=>{n.message&&this.update_dialog_values(t,n)})}},{fieldtype:"Section Break"},{fieldtype:"Float",fieldname:"qty",label:__("Quantity to Scan"),default:e[this.qty_field]||1},{fieldtype:"Column Break",fieldname:"column_break_1"},{fieldtype:"Float",read_only:1,fieldname:"scanned_qty",label:__("Scanned Quantity"),default:1},{fieldtype:"Section Break"}];return i&&_.push({fieldtype:"Link",fieldname:"batch_no",options:"Batch No",label:__("Batch No"),default:i,read_only:1,hidden:1}),s&&_.push({fieldtype:"Small Text",fieldname:"serial_no",label:__("Serial Nos"),default:s,read_only:1}),a&&_.push({fieldtype:"Data",fieldname:"barcode",options:"Barcode",label:__("Barcode"),default:a,read_only:1,hidden:1}),_}update_dialog_values(e,t){let{item_code:a,barcode:i,batch_no:s,serial_no:_}=t.message;if(this.dialog.set_value("barcode_scanner",""),a===e&&(this.dialog.get_value("barcode")===i||s||_)){if(s&&this.dialog.set_value("batch_no",s),_){this.validate_duplicate_serial_no(_);let n=this.dialog.get_value("serial_no")+`
`+_;this.dialog.set_value("serial_no",n)}let l=flt(this.dialog.get_value("scanned_qty"))+1;this.dialog.set_value("scanned_qty",l)}}validate_duplicate_serial_no(e){let t=this.dialog.get_value("serial_no")?this.dialog.get_value("serial_no").split(`
`):[];in_list(t,e)&&frappe.throw(__("Serial No {0} already scanned",[e]))}add_child_for_remaining_qty(e){if(this.remaining_qty&&this.remaining_qty>0){let t=this.frm.fields_dict[this.items_table_name].grid,a=frappe.model.add_child(this.frm.doc,t.doctype,this.items_table_name),i=["name","idx","batch_no","barcode","received_qty","serial_no","has_item_scanned"];for(let s in e)in_list(i,s)||(a[s]=e[s]);a[this.qty_field]=this.remaining_qty,this.qty_field=="qty"&&frappe.meta.has_field(a.doctype,"stock_qty")&&(a.stock_qty=this.remaining_qty*a.conversion_factor),this.frm.script_manager.trigger("item_code",a.doctype,a.name)}}async set_serial_no(e,t){if(t&&frappe.meta.has_field(e.doctype,this.serial_no_field)){let a=e[this.serial_no_field],i="";a?i=a+`
`+t:i=t,await frappe.model.set_value(e.doctype,e.name,this.serial_no_field,i)}}async set_barcode_uom(e,t){t&&frappe.meta.has_field(e.doctype,this.uom_field)&&await frappe.model.set_value(e.doctype,e.name,this.uom_field,t)}async set_batch_no(e,t){t&&frappe.meta.has_field(e.doctype,this.batch_no_field)&&await frappe.model.set_value(e.doctype,e.name,this.batch_no_field,t)}async so_ref(e,t){t&&frappe.meta.has_field(e.doctype,this.against_sales_order)&&await frappe.model.set_value(e.doctype,e.name,this.against_sales_order,t)}async soi_ref(e,t){t&&frappe.meta.has_field(e.doctype,this.so_detail)&&await frappe.model.set_value(e.doctype,e.name,this.so_detail,t)}async set_barcode(e,t){t&&frappe.meta.has_field(e.doctype,this.barcode_field)&&await frappe.model.set_value(e.doctype,e.name,this.barcode_field,t)}show_scan_message(e,t=null,a=1){t?this.show_alert(__("Row #{0}: Qty increased by {1}",[e,a]),"green"):this.show_alert(__("Row #{0}: Item added",[e]),"green")}is_duplicate_serial_no(e,t){var i;let a=(i=e[this.serial_no_field])==null?void 0:i.includes(t);return a&&this.show_alert(__("Serial No {0} is already added",[t]),"orange"),a}get_row_to_modify_on_scan(e,t,a,i){let s=this.frm.fields_dict[this.items_table_name].grid,_=t&&frappe.meta.has_field(s.doctype,this.batch_no_field),l=this.max_qty_field&&frappe.meta.has_field(s.doctype,this.max_qty_field),n=r=>{let o=r.item_code==e,c=!r[this.batch_no_field]||r[this.batch_no_field]==t,d=!a||r[this.uom_field]==a,h=flt(r[this.qty_field])<flt(r[this.max_qty_field]),f=r.has_item_scanned;return o&&d&&!f&&(!_||c)&&(!l||h)};return this.items_table.find(n)||this.get_existing_blank_row()}get_existing_blank_row(){return this.items_table.find(e=>!e.item_code)}play_success_sound(){this.success_sound&&frappe.utils.play_sound(this.success_sound)}play_fail_sound(){this.fail_sound&&frappe.utils.play_sound(this.fail_sound)}clean_up(){this.scan_barcode_field.set_value(""),refresh_field(this.items_table_name)}show_alert(e,t,a=3){frappe.show_alert({message:e,indicator:t},a)}};})();
//# sourceMappingURL=methods.bundle.VJ2UBXWN.js.map
